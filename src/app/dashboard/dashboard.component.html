<div class="app-container">
  <!-- Header -->
  <header class="main-header">
    <div class="logo-container" (click)="navigateHome()">
      <img src="assets/svg/DABubble.svg" alt="Logo" class="logo" />
    </div>

    <div class="search-container">
      <input
        type="text"
        class="search-input"
        placeholder="Devspace durchsuchen"
      />
      <div class="search-icon">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          width="20"
          height="20"
        >
          <path
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
      </div>
    </div>

    <div class="profile-container">
      <div class="user-name">
        {{ activUser.firstName }} {{ activUser.lastName }}
      </div>
      <div class="user-avatar">
        <img
          src="assets/icons/avatars/{{ activUser.avatar }}"
          alt="Profil Images"
        />
        <div class="status-indicator" [class.active]="activUser.isActive"></div>
      </div>
      <div class="dropdown-icon">
        <img src="assets/icons/arrow_down.svg" alt="arrow_down" />
      </div>
      <div class="menue">
        <div class="menue-point" (click)="openDialogProfil(activUserId)">
          Profil
        </div>
        <div class="menue-point" (click)="logout()">Log out</div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="dashboard-container">
    <div class="sidebar" [class.collapsed]="sidebar.sidebarCollapsed">
      <app-sidebar #sidebar 
        (channelSelected)="handleChannelSelected($event)"
        (channelDeleted)="handleChannelDeleted($event)"
        (directMessageSelected)="handleDirectMessageSelected($event)"
      ></app-sidebar>
    </div>

    <!-- Workspace Menu at left edge -->
    <div class="workspace-menu">
      <div class="menu-item" (click)="sidebar.toggleSidebar()">
        <div class="menu-icon">
          <img
            src="assets/icons/dashboard/workspace-menu-close.svg"
            alt="Toggle Sidebar"
            class="toggle-sidebar-icon"
            [class.rotate-left]="sidebar.sidebarCollapsed"
            [class.rotate-right]="!sidebar.sidebarCollapsed"
          />
        </div>
        <div class="menu-text">
          {{ sidebar.sidebarCollapsed ? 'Workspace-Menü öffnen' : 'Workspace-Menü schließen' }}
        </div>
      </div>
    </div>

    <div class="chat-area" [class.expanded]="sidebar.sidebarCollapsed">
      <!-- Regular channel chat -->
      <app-chat-area 
        #chatArea 
        *ngIf="!isDirectMessageActive"
        [channelName]="selectedChannel.name" 
        [channelId]="selectedChannel.id"
        (mentionClicked)="showUserTaggingInChat()"
        (threadOpened)="openThreadWithMessage($event)"
      ></app-chat-area>
      
      <!-- Direct message chat -->
      <div *ngIf="isDirectMessageActive && selectedDirectMessage" class="direct-message-container">
        <div class="direct-message-header">
          <div class="user-info">
            <div class="user-avatar">
              <img [src]="selectedDirectMessage.avatar" [alt]="selectedDirectMessage.name">
              <div class="status-indicator" [class.online]="selectedDirectMessage.online"></div>
            </div>
            <div class="user-name">{{ selectedDirectMessage.name }}</div>
          </div>
        </div>
        
        <div class="direct-message-content">
          <div class="direct-message-info">
            <div class="user-avatar-container">
              <div class="user-avatar large">
                <img [src]="selectedDirectMessage.avatar" [alt]="selectedDirectMessage.name">
              </div>
              <div class="user-name large">{{ selectedDirectMessage.name }}</div>
            </div>
            <p class="conversation-info">
              Diese Unterhaltung findet nur zwischen <span class="user-mention">{{'@'}}{{ selectedDirectMessage.name }}</span> und dir statt.
            </p>
          </div>
          
          <div class="message-input-container">
            <div class="message-input-wrapper">
              <textarea
                class="message-input"
                placeholder="Nachricht an {{ selectedDirectMessage.name }}"
                [(ngModel)]="directMessageInput"
                (keydown.enter)="$event.preventDefault(); sendDirectMessage()"
                (keyup)="handleInputKeyup($event)"
              ></textarea>
              <div class="input-actions">
                <div style="display: flex; align-items: center;">
                  <button class="react-button emoji-button" (click)="openEmojiPicker()">
                    <img src="./assets/icons/dashboard/reaction.svg" alt="Emoji" />
                  </button>
                  <button class="react-button" (click)="insertChannelTag()">
                    <span class="channel-hashtag">#</span>
                  </button>
                  <button class="react-button" (click)="insertMention()">
                    <img src="./assets/icons/dashboard/mark.svg" alt="Mention" />
                  </button>
                </div>

                <button
                  class="send-button"
                  [disabled]="!directMessageInput || !directMessageInput.trim()"
                  (click)="sendDirectMessage()"
                >
                  <img src="./assets/icons/dashboard/send.svg" alt="Send" />
                </button>
              </div>
            </div>
            
            <!-- Tagging Modals - Moved outside the message-input-wrapper -->
            <div class="tagging-modal-container">
              <!-- Channel Tagging Modal -->
              <div class="tagging-modal channel-tagging" *ngIf="showChannelTagging">
                <div class="tagging-header">
                  <div class="tagging-title">Channels</div>
                </div>
                <div class="tagging-list">
                  <div 
                    *ngFor="let channel of filteredChannels" 
                    class="tagging-item"
                    (click)="selectChannelTag(channel)"
                  >
                    <span class="channel-tag-icon">#</span>
                    <span class="channel-tag-name">{{ channel.name }}</span>
                  </div>
                  <div class="tagging-empty" *ngIf="filteredChannels.length === 0">
                    Keine passenden Channels gefunden
                  </div>
                </div>
              </div>
              
              <!-- User Tagging Modal -->
              <div class="tagging-modal user-tagging" *ngIf="showUserTagging">
                <div class="tagging-list">
                  <div 
                    *ngFor="let user of filteredUsers" 
                    class="tagging-item"
                    (click)="selectUserTag(user)"
                  >
                    <div class="user-tag-avatar">
                      <img [src]="user.avatar" [alt]="user.name">
                      <div class="status-indicator" [class.online]="user.online"></div>
                    </div>
                    <span class="user-tag-name">{{ user.name }}</span>
                  </div>
                  <div class="tagging-empty" *ngIf="filteredUsers.length === 0">
                    Keine passenden Benutzer gefunden
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Emoji Picker -->
            <div *ngIf="showEmojiPicker" class="emoji-picker-container">
              <div class="custom-emoji-picker">
                <div class="emoji-picker-header">
                  <div class="emoji-search">
                    <input type="text" placeholder="Suchen" class="emoji-search-input">
                    <button class="emoji-search-button">
                      <span>🔍</span>
                    </button>
                  </div>
                  <div class="emoji-picker-close" (click)="openEmojiPicker()">
                    <span>×</span>
                  </div>
                </div>
                
                <div class="emoji-picker-content">
                  <div class="emoji-categories">
                    <button class="emoji-category-btn active">➕</button>
                    <button class="emoji-category-btn">😀</button>
                    <button class="emoji-category-btn">🐶</button>
                    <button class="emoji-category-btn">🍎</button>
                    <button class="emoji-category-btn">🏀</button>
                    <button class="emoji-category-btn">🚗</button>
                    <button class="emoji-category-btn">💡</button>
                    <button class="emoji-category-btn">🔣</button>
                    <button class="emoji-category-btn">🏁</button>
                  </div>
                  
                  <div class="emoji-list">
                    <div class="emoji-section">
                      <div class="emoji-section-title">Kürzlich verwendet</div>
                      <div class="emoji-grid">
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '👍'}})">👍</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '😀'}})">😀</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '😉'}})">😉</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '😍'}})">😍</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '😜'}})">😜</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '😂'}})">😂</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '🤣'}})">🤣</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '😱'}})">😱</button>
                      </div>
                    </div>
                    
                    <div class="emoji-section">
                      <div class="emoji-section-title">Smileys & Personen</div>
                      <div class="emoji-grid">
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '😀'}})">😀</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '😃'}})">😃</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '😄'}})">😄</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '😁'}})">😁</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '😆'}})">😆</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '😅'}})">😅</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '🤣'}})">🤣</button>
                        <button class="emoji-btn" (click)="addEmoji({emoji: {native: '😂'}})">😂</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="thread-section" [class.hidden]="!showThreadView">
      <div class="thread-header">
        <div class="thread-title">
          Thread 
          <span class="thread-channel" *ngIf="!isDirectMessageActive"># {{ selectedChannel.name }}</span>
          <span class="thread-channel" *ngIf="isDirectMessageActive && selectedDirectMessage">{{ selectedDirectMessage.name }}</span>
        </div>
        <button class="close-button" (click)="toggleThreadView()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            width="24"
            height="24"
          >
            <path
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>

      <app-thread-view (closeThread)="toggleThreadView()"></app-thread-view>
    </div>
  </div>
</div>
